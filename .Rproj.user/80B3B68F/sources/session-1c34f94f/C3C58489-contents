options(mc.cores = 1)

if (requireNamespace("BiocParallel", quietly = TRUE)) {
  library(BiocParallel)
  register(SerialParam())
}

# 3. Normalització ####
source(file = "./libs.R")
source(file = "./libs_exprs.R")
load("./RESULTATS_BIOPSIA_RNA/OBJECTES_R/data_raw_biopsia")
data_raw_biopsia@phenoData@data

dim(data_raw_biopsia@assayData$exprs)

# Normalització amb rma. Posteriorment s'arreglarà el batch effect amb combat
# Normalitzem sense filtrar (en biopsia no fa falta que filtrem els pacients)

data_rma_biopsia <- oligo::rma(data_raw_biopsia, normalize = FALSE, background = FALSE)

boxplot(data_rma_biopsia,las=2,main="data_rma_biopsia") # Se te que desecarrega?

# matriu_exprs<-data_rma_biopsia@assayData$exprs
# write.csv(matriu_exprs, file="./RESULTATS_BIOPSIA_RNA/TAULES/matriu_exprs.csv")

## Annotació featureData Affymetrix

annotate <- read.csv("./pd.clariom.s.human.csv", sep=",",comment.char = "#")

annotate$gene_symbol<-unlist(lapply(annotate$gene_assignment, function(x) gsub(" ","",strsplit(x,"//")[[1]][2])))
annotate$gene_entrez<-unlist(lapply(annotate$gene_assignment, function(x) gsub(" ","",strsplit(x,"//")[[1]][5])))

colnames(annotate)
annotate<-annotate[,c(1:3,17,18,22:23)]

# Unió phenoData amb el featureData mitjançant el nom del probeset. 

data_rma_biopsia <- data_rma_biopsia[(rownames(data_rma_biopsia)%in%annotate$transcript_cluster_id),]

fd <-annotate[match(rownames(data_rma_biopsia),annotate$transcript_cluster_id),]

# Convertim el featureData en un annotated dataframe
featureData <- new("AnnotatedDataFrame", data=fd)
# Carreguem el featureData al expresionset de data_rma_biopsia
featureData(data_rma_biopsia) <- featureData

save(data_rma_biopsia,file="./RESULTATS_BIOPSIA_RNA/OBJECTES_R/data_rma_biopsia")

# PCA normalitzat

exp_rma <- Biobase::exprs(data_rma_biopsia)
PCA_rma <- prcomp(t(exp_rma), scale. = FALSE)

percentVar <- round(100*PCA_rma$sdev^2/sum(PCA_rma$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])

dataGG <- data.frame(PC1 = PCA_rma$x[,1], PC2 = PCA_rma$x[,2],
                     Disease =
                       data_rma_biopsia@phenoData@data$Batch,
                     Individual =
                       data_rma_biopsia@phenoData@data$pacient)

batch<-as.factor(data_rma_biopsia@phenoData@data$Batch)
PCA_rma_data <- ggplot(dataGG, aes(PC1, PC2)) +
  geom_point(aes(colour = as.factor(batch)),size=10) +
  geom_text(aes(label=Individual),color="gray20")+
  ggtitle("PCA plot") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw()

#PCA_rma_data

png("./RESULTATS_BIOPSIA_RNA/PLOTS/PCA_rma_data_score.png", height=900, width = 900, res = 100)
print(PCA_rma_data)
dev.off()

