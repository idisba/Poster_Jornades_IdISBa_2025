# 4. Expressió diferencial ####

# source("/usr/local/lib/R/site-library/AnalisisArrays2/templates/llibreries_Informes.R") # Referència externa, no funciona . 

library(clusterProfiler)
library(genefilter)
library(dplyr)
library(limma)
load("./RESULTATS_BIOPSIA_RNA/OBJECTES_R/data_rma_biopsia")

data_rma_biopsia <- data_rma_biopsia[data_rma_biopsia@featureData@data$category=="main"&!is.na(data_rma_biopsia@featureData@data$gene_entrez),]

## Expressió diferencial entre els grups de pacients Remission / No Remission #### 

table(data_rma_biopsia@phenoData@data$clinical._remission)

## Control vs Cas
groups = data_rma_biopsia@phenoData@data$clinical._remission
groups<-gsub("0","No_Remission",groups)
groups<-gsub("1","Remission",groups)
groups<-as.factor(groups)

### Limma
design = model.matrix(~ 0 + groups)
colnames(design)<-gsub("groups","",colnames(design))
data_rma_biopsia_exprs<-exprs(data_rma_biopsia)

data.fit = lmFit(data_rma_biopsia_exprs,design)

contrast.matrix = makeContrasts(No_Remission-Remission,levels=design)
data.fit.con = contrasts.fit(data.fit,contrast.matrix)
data.fit.eb = eBayes(data.fit.con)

table_DEG_remission <- topTable(data.fit.eb, number = Inf,adjust.method = "fdr",genelist = data_rma_biopsia@featureData@data)

save(table_DEG_remission, file = "./RESULTATS_BIOPSIA_RNA/TAULES/table_DEG_remission")
write.csv(table_DEG_remission, file= "./RESULTATS_BIOPSIA_RNA/TAULES/table_DEG_remission.csv")

table_DEG_sig_RNA_remission <- table_DEG_remission %>% 
                                    filter(adj.P.Val <=0.05)
dim(table_DEG_sig_RNA_remission)
# 5836 RNA DE significatius en biòpsia

save(table_DEG_remission, table_DEG_sig_RNA_remission, file = "./RESULTATS_BIOPSIA_RNA/OBJECTES_R/taules_REMISSION")

# ---------------------------------------------------------------------------

exp_rma <- log2(Biobase::exprs(data_rma_biopsia))
PCA_rma <- prcomp(t(exp_rma), scale. = FALSE)

percentVar <- round(100*PCA_rma$sdev^2/sum(PCA_rma$sdev^2),1)
sd_ratio <- sqrt(percentVar[2] / percentVar[1])
table(data_rma_biopsia@phenoData@data$clinical._remission)
dataGG <- data.frame(PC1 = PCA_rma$x[,1], PC2 = PCA_rma$x[,2],
                     Disease =
                       data_rma_biopsia@phenoData@data$clinical._remission,
                     Individual =
                       data_rma_biopsia@phenoData@data$pacient)


PCA_plot3 <- ggplot(dataGG, aes(PC1, PC2)) +
  geom_point(aes(colour = as.factor(Disease)),size=10) +
  geom_text(aes(label=Individual),color="gray20")+
  ggtitle("PCA plot of the calibrated, summarized data") +
  xlab(paste0("PC1, VarExp: ", percentVar[1], "%")) +
  ylab(paste0("PC2, VarExp: ", percentVar[2], "%")) +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_bw()

PCA_plot3# Se te que descarrega?
