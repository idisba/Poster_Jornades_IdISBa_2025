
# Informacio de execuccio
scripts <- c(
  "./Temps_inicial.R",
  "./libs.R",
  "./libs_exprs.R",
  "./01_Lectura_dades.R",
  "./02_Quality_control.R",
  "./03_Normalitzacio.R",
  "./04_Expressio_diferencial_SCORE.R",
  "./05_Expressio_diferencial_SCORE.R"
)

resultats <- list()

# Per buidar la informacio que hi ha, abans de tornar a fer s'analisis
sink("./session_info/execution_info.txt", append = FALSE)
sink()

for (script in scripts) {
  tryCatch({
    source(script)
    sink("./session_info/execution_info.txt", append = TRUE)
    cat(paste0("âœ… ", script, " executat correctament.\n"))
    sink("./session_info/session_info.txt", append = TRUE)
    resultats[[script]] <- "Correcte"
  }, error = function(e) {
    sink("./session_info/execution_info.txt", append = TRUE)
    cat("âš ï¸ Error durant l'execuciÃ³ de ", script, ":\n")
    cat("Missatge: ", conditionMessage(e), "\n")
    cat("TraÃ§a:\n")
    traceback(2, max.lines = 5)
    sink()
    resultats[[script]] <-"Error"
  })
}

# Escriure resum final al fitxer

sink("./session_info/execution_info.txt", append = TRUE)
cat("\nðŸ“‹ Resum de l'execuciÃ³:\n")
for (script in names(resultats)) {
  cat(paste0("- ", script, ": ", resultats[[script]], "\n"))
}
sink()

# Session info i  Durada de execuccio

# Reiniciar el fitxer (esborrar contingut anterior)
sink("./session_info/session_info.txt", append = FALSE)
cat("ðŸ“„ SessiÃ³ iniciada\n")
sink()

source("./Save_session_info.R")
source("./Temps_final.R")
durada <- end_time - start_time

# Format llegible del temps
temps_execucio_format <- function(start_time, end_time) {
  durada <- as.numeric(difftime(end_time, start_time, units = "secs"))
  hores <- floor(durada / 3600)
  minuts <- floor((durada %% 3600) / 60)
  segons <- round(durada %% 60)
  parts <- c()
  if (hores > 0) parts <- c(parts, paste(hores, ifelse(hores == 1, "hora", "hores")))
  if (minuts > 0) parts <- c(parts, paste(minuts, ifelse(minuts == 1, "minut", "minuts")))
  if (segons > 0 || length(parts) == 0) parts <- c(parts, paste(segons, ifelse(segons == 1, "segon", "segons")))
  paste(parts, collapse = " i ")
}

durada_format <- temps_execucio_format(start_time, end_time)
sink("./session_info/session_info.txt", append = TRUE)
cat("Data d'execuciÃ³ inicial: ", format(start_time), "\n")
cat("Data d'execuciÃ³ final: ", format(end_time), "\n")
cat("Temps total d'execuciÃ³: ", durada_format, "\n\n")
sink()
